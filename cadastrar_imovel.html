<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocaHouse</title>
    <link href="css/styles.css" rel="stylesheet" type="text/css" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
        rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>

<style>
    .carousel-control.left {
        left: -100px !important;
    }

    .carousel-control.right {
        right: -100px !important;
    }

    .carousel-control .icon-prev,
    .carousel-control .icon-next {
        background-color: #678a73;
        border-radius: 50%;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        opacity: 1;
    }
</style>

<body>
    <header></header>

    <div class="container">
        <input type="hidden" id="status-imovel">
        <div class="col-md-10 col-md-offset-1 mt-2">
            <div class="text-center mb-4">
                <h3>Cadastrar imóvel</h3>
            </div>
            <form id="form-cadastrar-imovel">
                <fieldset class="fieldset-gray-pd">
                    <legend class="legend-field">Informações</legend>
                    <div class="form-group">
                        <label for="DescricaoImovel">Descrição*:</label>
                        <input type="text" class="form-control obrigatorio" id="DescricaoImovel" name="DescricaoImovel">
                    </div>

                    <div class="form-group row" id="container-comodos">
                        <div class="col-xs-12 col-md-4 col-lg-2">
                            <label for="BanheirosImovel">Banheiro(s)*:</label>
                            <input type="number" class="form-control obrigatorio" id="BanheirosImovel"
                                name="BanheirosImovel" min="0" max="10" onkeydown="return false;" data-comodo="1">
                        </div>
                        <div class="col-xs-12 col-md-4 col-lg-2">
                            <label for="QuartosImovel">Quarto(s)*:</label>
                            <input type="number" class="form-control obrigatorio" id="QuartosImovel"
                                name="QuartosImovel" min="0" max="10" onkeydown="return false;" data-comodo="2">
                        </div>
                        <div class="col-xs-12 col-md-4 col-lg-2">
                            <label for="SalasImovel">Sala(s)*:</label>
                            <input type="number" class="form-control obrigatorio" id="SalasImovel" name="SalasImovel"
                                min="0" max="10" onkeydown="return false;" data-comodo="3">
                        </div>
                        <div class="col-xs-12 col-md-4 col-lg-2">
                            <label for="CozinhasImovel">Cozinha(s)*:</label>
                            <input type="number" class="form-control obrigatorio" id="CozinhasImovel"
                                name="CozinhasImovel" min="0" max="10" onkeydown="return false;" data-comodo="4">
                        </div>
                        <div class="col-xs-12 col-md-4 col-lg-2">
                            <label for="GaragemImovel">Garagem(ns)*:</label>
                            <input type="number" class="form-control obrigatorio" id="GaragemImovel"
                                name="GaragemImovel" min="0" max="10" onkeydown="return false;" data-comodo="5">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12 col-md-6">
                            <small><strong>Dica:</strong> utilize as setas para alterar a quantidade de cômodos</small>
                        </div>
                    </div>
                    <br>
                    <div class="form-group row">
                        <div class="col-xs-12 col-md-4">
                            <label for="valor">Preço*:</label>
                            <input type="number" class="form-control obrigatorio" id="valor" name="valor" min="0">
                        </div>
                        <div class="col-xs-12 col-md-3">
                            <label for="tamanho">Tamanho (em m²)*:</label>
                            <input type="number" class="form-control obrigatorio" id="tamanho" name="tamanho" min="0">
                        </div>
                    </div>
                </fieldset>
                <br />

                <fieldset class="fieldset-gray-pd">
                    <legend class="legend-field">Localização</legend>
                    <div class="form-group row">
                        <div class="col-xs-6">
                            <label for="CepImovel">CEP*:</label>
                            <input type="text" class="form-control obrigatorio" id="CepImovel" name="numero_cep"
                                placeholder="_____-___">
                        </div>

                        <div class="col-xs-4">
                            <label for="CidadeImovel">Cidade:</label>
                            <input type="text" class="form-control obrigatorio" id="CidadeImovel" name="CidadeImovel"
                                disabled>
                        </div>

                        <div class="col-xs-2">
                            <label for="UFImovel">Estado:</label>
                            <input type="text" class="form-control obrigatorio" id="UFImovel" name="UFImovel" disabled>
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-xs-6">
                            <label for="EnderecoImovel">Endereço:</label>
                            <input type="text" class="form-control obrigatorio" id="EnderecoImovel"
                                name="EnderecoImovel" disabled>
                        </div>
                        <div class="col-xs-6">
                            <label for="BairroImovel">Bairro:</label>
                            <input type="text" class="form-control obrigatorio" id="BairroImovel" name="BairroImovel"
                                disabled>
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-xs-12 col-md-6">
                            <label for="complemento">Complemento:</label>
                            <input type="text" class="form-control" id="complemento" name="complemento">
                        </div>
                        <div class="col-xs-12 col-md-4">
                            <label for="NumeroImovel">Número*:</label>
                            <input type="text" class="form-control obrigatorio" id="NumeroImovel" name="numero">
                        </div>
                    </div>
                </fieldset>
                <br />
                <div class="text-center">
                    <button type="submit" class="btn btn-back-green" id="btn-cadastrar">Cadastrar</button>
                </div>
            </form>

        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script>
        var editar = getQueryVariable('editar');
        var id_imovel = getQueryVariable('id');

        let idBanheiro = null;
        let idQuarto = null;
        let idSala = null;
        let idCozinha = null;
        let idGaragem = null;

        $(document).ready(function () {
            $("#CepImovel").mask('00000-000');
            $("#TelefoneImovel").mask('(00) 00000-0000');
            $('#NumeroImovel').mask('0000', {
                translation: {
                    '0': { pattern: /[0-9]/ }
                },
                onKeyPress: function (val, e, field, options) {
                    if (val.length === 0) {
                        $(field).val('');
                    }
                    if (val.length === 4) {
                        $(field).val(val.slice(0, 1) + '-' + val.slice(1));
                    }
                },
                onComplete: function (val) {
                    if (val.length === 4) {
                        $('#NumeroImovel').val(val.slice(0, 1) + '-' + val.slice(1));
                    }
                }
            });

            $("#CepImovel").on('keydown', function (e) {
                if (e.key == 'Tab') {
                    var cep = $("#CepImovel").val().replace("-", "");
                    viaCEP(cep, function (response) {
                        if (response) {
                            $("#CidadeImovel").val(response.localidade);
                            $("#UFImovel").val(response.uf);
                            $("#EnderecoImovel").val(response.logradouro);
                            $("#BairroImovel").val(response.bairro);
                        }
                    });
                }

            });


            //CARREGAR INFORMAÇOES DO IMOVEL CADASTRADO PARA EDITAR
            if (editar) {
                $.ajax({
                    url: "http://localhost:8080/api/v1/imoveis/buscar/" + id_imovel,
                    method: "GET",
                    contentType: "application/json",
                    dataType: "json",
                    headers: {
                        Authorization: "Bearer " + localStorage.getItem("userToken"),
                    },
                    success: function (response) {
                        console.log(response)

                        $("#status-imovel").attr('data-status', response.status);
                        $("#DescricaoImovel").val(response.descricao);

                        $.each(response.comodos, function (key, value) {
                            var comodo = value.comodo.id;
                            $('[data-comodo="' + comodo + '"]').val(comodo)
                        });

                        for (let i of response.comodos) {
                            switch (i.comodo.id) {
                                case 1:
                                    $("#BanheirosImovel").val(i.quantidade);
                                    idBanheiro = i.id;
                                    break;
                                case 2:
                                    $("#QuartosImovel").val(i.quantidade);
                                    idQuarto = i.id;
                                    break;
                                case 3:
                                    $("#SalasImovel").val(i.quantidade);
                                    idSala = i.id;
                                    break;
                                case 4:
                                    $("#CozinhasImovel").val(i.quantidade);
                                    idCozinha = i.id;
                                    break;
                                case 5:
                                    $("#GaragemImovel").val(i.quantidade);
                                    idGaragem = i.id;
                                    break;
                            }
                        }

                        $("#valor").val(response.valor);
                        $("#tamanho").val(response.tamanho);
                        $("#CepImovel").val(response.cep.numero);
                        $("#CepImovel").trigger($.Event('keydown', { key: 'Tab' }));
                        $("#complemento").val(response.complemento);
                        $("#NumeroImovel").val(response.numero);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        var responseError = JSON.parse(jqXHR.responseText);
                        alert("Erro ao carregar imóvel: " + responseError.mensagens);
                    },
                });
            }

            $("#form-cadastrar-imovel").on('submit', function (e) {
                e.preventDefault();
                verificaLogin();
                var count_empty = 0;

                $(this).find('input, textarea').each(function () {
                    if ($(this).val() == '' && $(this).hasClass('obrigatorio')) {
                        $(this).css('border', '1px solid red');
                        count_empty++;
                    }
                });

                const formData = {
                    status: editar ? $("#status-imovel").data('status') : 0,
                    descricao: $("#DescricaoImovel").val(),
                    numero: $("#NumeroImovel").val(),
                    complemento: $("#complemento").val(),
                    valor: parseFloat($("#valor").val()),
                    tamanho: parseFloat($("#tamanho").val()),
                    numero_cep: $("#CepImovel").val()
                };
                console.log(formData)

                const id = localStorage.getItem('userId');
                const token = localStorage.getItem('userToken');
                if (id) {
                    $.ajax({
                        url: editar ? 'http://localhost:8080/api/v1/imoveis/atualizar/' + id_imovel : 'http://localhost:8080/api/v1/imoveis/cadastrar/' + id,
                        method: editar ? 'PUT' : 'POST',
                        data: JSON.stringify(formData),
                        contentType: 'application/json',
                        dataType: 'text',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('userToken')
                        },
                        success: function (response, textStatus, jqXHR) {
                            if (!editar) var id_imovel_cad = jqXHR.getResponseHeader('Location').match(/\/(\d+)$/)[1];

                            $.each($("#container-comodos").find('input[type="number"]'), function () {
                                if ($(this).val() > 0 || $(this).val() != '') {
                                    var obj = {
                                        "quantidade": $(this).val(),
                                        "comodo_id": $(this).attr('data-comodo')
                                    }

                                    let idAtualizacao = null;
                                    if (editar) {
                                        switch (obj.comodo_id) {
                                            case '1':
                                                idAtualizacao = idBanheiro;
                                                break;
                                            case '2':
                                                idAtualizacao = idQuarto;
                                                break;
                                            case '3':
                                                idAtualizacao = idSala;
                                                break;
                                            case '4':
                                                idAtualizacao = idCozinha;
                                                break;
                                            case '5':
                                                idAtualizacao = idGaragem;
                                                break;
                                        }
                                    }

                                    $.ajax({
                                        url: editar ? 'http://localhost:8080/api/v1/comodos-imoveis/atualizar/' + idAtualizacao : 'http://localhost:8080/api/v1/comodos-imoveis/cadastrar/' + id_imovel_cad,
                                        method: editar ? 'PUT' : 'POST',
                                        data: JSON.stringify(obj),
                                        contentType: 'application/json',
                                        dataType: 'text',
                                        headers: {
                                            'Authorization': 'Bearer ' + localStorage.getItem('userToken')
                                        },
                                        success: function (response) {
                                            console.log(editar ? 'Cômodos atualizados' : 'Comodos cadastrados')
                                        },
                                        error: function (jqXHR, textStatus, errorThrown) {
                                            var responseError = JSON.parse(jqXHR.responseText);
                                            alert('Erro ao cadastrar: ' + responseError.mensagens);
                                            console.log(responseError);
                                        }
                                    });
                                }
                            });

                            alert(editar ? "Os dados do seu imóvel foram atualizados com sucesso!" : "Seu imóvel foi cadastrado com sucesso!");

                            //window.location.href = 'perfil.html';
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            var responseError = JSON.parse(jqXHR.responseText);
                            alert('Erro ao cadastrar: ' + responseError.mensagens);
                            console.log(responseError);
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>